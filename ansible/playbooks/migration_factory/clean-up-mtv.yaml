---
- name: Remove MTV objects (keep Provider)
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - redhat.openshift
    - redhat.openshift_virtualization


  vars:
#    ns: openshift-mtv
    #target_ns: migrate-vsphere

    #network_map_name: vsphere-network-map
    #storage_map_name: vsphere-storage-map
    #plan_name: vsphere-migration-plan
    migration_name: "{{ plan_name }}-migration"
    bearer_token: "{{ lookup('env', 'K8S_AUTH_API_KEY') }}"
    #nad_names:
    #  - net-1085

    #remove_target_namespace: false

  tasks:
    - name: Debug what will be removed
      debug:
        msg:
          ns: "{{ ns }}"
          target_ns: "{{ target_ns }}"
          nad_names: "{{ nad_names }}"
          network_map: "{{ network_map_name }}"
          storage_map: "{{ storage_map_name }}"
          plan: "{{ plan_name }}"
          migration: "{{ migration_name }}"

    - name: Delete NetworkAttachmentDefinitions in target namespace
      redhat.openshift.k8s:
        state: absent
        namespace: "{{ target_ns }}"
        validate_certs: false
        definition:
          apiVersion: k8s.cni.cncf.io/v1
          kind: NetworkAttachmentDefinition
          metadata:
            name: "{{ nad_names }}"
            namespace: "{{ target_ns }}"

    - name: Delete NetworkMap resource in MTV namespace
      redhat.openshift.k8s:
        state: absent
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: NetworkMap
          metadata:
            name: "{{ network_map_name }}"
            namespace: "{{ ns }}"
      ignore_errors: true

    - name: Delete StorageMap resource in MTV namespace
      redhat.openshift.k8s:
        state: absent
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: StorageMap
          metadata:
            name: "{{ storage_map_name }}"
            namespace: "{{ ns }}"
      ignore_errors: true

    - name: Delete Plan resource in MTV namespace
      redhat.openshift.k8s:
        state: absent
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Plan
          metadata:
            name: "{{ plan_name }}"
            namespace: "{{ ns }}"
      ignore_errors: true

    - name: Delete Migration resource in MTV namespace
      redhat.openshift.k8s:
        state: absent
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Migration
          metadata:
            name: "{{ migration_name }}"
            namespace: "{{ ns }}"
      ignore_errors: true

    - name: List VMs on OpenShift Virtualization
      redhat.openshift_virtualization.kubevirt_vm_info:
        host: "{{ lookup('env', 'K8S_AUTH_HOST') }}"
        api_key: "{{ lookup('env', 'K8S_AUTH_API_KEY') }}"
        validate_certs: false
        namespace: "{{ target_ns }}"
      register: result
      
    - name: Set list vms by name
      ansible.builtin.set_fact:
        vms_list: "{{ result.resources | map(attribute='metadata.name') | list }}"

    - name: Delete VirtualMachine on OCP "{{ target_ns }}"
      redhat.openshift_virtualization.kubevirt_vm:
        host: "{{ lookup('env', 'K8S_AUTH_HOST') }}"
        api_key: "{{ lookup('env', 'K8S_AUTH_API_KEY') }}"
        validate_certs: false
        state: absent
        name: "{{ item }}"
        namespace: "{{ target_ns }}"
      loop: "{{ vms_list }}"

    - name: List PVCs in target namespace
      redhat.openshift.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: "{{ target_ns }}"
      register: pvc_list

    - name: Delete PVC on OCP "{{ target_ns }}"
      redhat.openshift.k8s:
        host: "{{ lookup('env', 'K8S_AUTH_HOST') }}"
        api_key: "{{ lookup('env', 'K8S_AUTH_API_KEY') }}"
        validate_certs: false
        state: absent
        name: "{{ item.metadata.name }}"
        namespace: "{{ target_ns }}"
      loop: "{{ pvc_list }}"


    - name: Delete target namespace
      redhat.openshift.k8s:
        state: absent
        validate_certs: false
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ target_ns }}"
      ignore_errors: true

    - name: Final debug - summary of deletion attempts
      debug:
        msg:
          nad_delete_results: "{{ delete_nad_results.results | default([]) | map(attribute='msg') | list }}"
          vmi_delete_results: "{{ delete_vmi_results.results | default([]) | map(attribute='msg') | list }}"
          vm_delete_results: "{{ delete_vm_results.results | default([]) | map(attribute='msg') | list }}"
          pvc_delete_results: "{{ delete_pvc_results.results | default([]) | map(attribute='msg') | list }}"
          network_map_deleted: "{{ network_map_name }}"
          storage_map_deleted: "{{ storage_map_name }}"
          plan_deleted: "{{ plan_name }}"
          migration_deleted: "{{ migration_name }}"
          provider_left_intact: "Provider resource is not touched by this playbook"

