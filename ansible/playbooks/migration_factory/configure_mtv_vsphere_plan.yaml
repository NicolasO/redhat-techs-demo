---
- name: Configure MTV objects and start migration (vSphere -> OCP)
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - redhat.openshift

  vars:
    # Namespaces and cluster info
#    ns: openshift-mtv                   # Namespace where providers, maps exist
#    target_ns: migrate-vsphere          # Target Namespace where migrated VMs will land and where net-attach-def is created
#    cluster_name: your-cluster
#    domain: example.com

    # MTV API endpoint for forklift inventory
    forklift_route: "forklift-inventory-{{ ns }}.apps.{{ cluster_name }}.{{ domain }}"

    # Authentication (provide via env or override here)
    bearer_token: "{{ lookup('env', 'K8S_AUTH_API_KEY') }}"

    # vSphere provider details (must match Secret and Provider CR names)
#    provider_name: vsphere-provider
    #provider_name_secret: vsphere-provider-secret

    # Credentials for provider secret (set appropriately)
#    vsphere_url: "https://your-vcenter.example.com/sdk"
#    vsphere_user: "administrator@vsphere.local"
 #    vsphere_password: "your-password"

    # Storage / network map names
   # storage_map_name: vsphere-storage-map
   # network_map_name: vsphere-network-map

    # Plan and migration names
    #plan_name: vsphere-migration-plan

    # StorageClass name to use on target (change to your cluster's)
    #storage_destination_storageclass: ocs-external-storagecluster-ceph-rbd-virtualization

    # Folder path regex to filter VMs by inventory path in vCenter
    #filter_vm_folder_path: "^/HIT_Solutions/vm/Red-Hat_JJ/MTV/"

    # Optional additional VM name regex filter (set to "" or omit to disable)
    #filter_vm_name_regex: ""

    # Optional vm_names override list (empty disables)
    vm_names: []
    vm_ids: []

    # Network mappings for NetworkMap resource (set your source/destination network mapping here)
    network_mappings: []

    # Source storage map name (fallback)
    #storage_map_source_name: "vSphere-datastore"

    # Whether to start migration automatically (false = just create Plan)
    # start_migration: false

    migration_wait_timeout: 1800

  tasks:
    - name: Ensure provider secret exists (vSphere)
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ provider_name_secret }}"
            namespace: "{{ ns }}"
            labels:
              createdForProviderType: vsphere
              createdForResourceType: providers
          type: Opaque
          stringData:
            url: "{{ vsphere_url }}"
            user: "{{ vsphere_user }}"
            password: "{{ vsphere_password }}"
            insecureSkipVerify: "true"

    - name: Create Provider custom resource (vSphere) if not present
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Provider
          metadata:
            name: "{{ provider_name }}"
            namespace: "{{ ns }}"
          spec:
            type: vsphere
            url: "{{ vsphere_url }}"
            secret:
              name: "{{ provider_name_secret }}"
              namespace: "{{ ns }}"

    - name: Query provider list to determine provider UID
      uri:
        url: "https://{{ forklift_route }}/providers/vsphere"
        method: GET
        validate_certs: false
        headers:
          Authorization: "Bearer {{ bearer_token }}"
      register: provider_list
      failed_when: provider_list.status not in [200,201,202]

    - name: Set provider_uid from provider list
      set_fact:
        provider_uid: "{{ (provider_list.json | selectattr('name','equalto', provider_name) | list)[0].uid }}"

    - name: Get VMs for provider
      uri:
        url: "https://{{ forklift_route }}/providers/vsphere/{{ provider_uid }}/vms"
        method: GET
        validate_certs: false
        headers:
          Authorization: "Bearer {{ bearer_token }}"
      register: provider_vms

    - name: Build filtered VM list by folder path and optional name regex
      ansible.builtin.set_fact:
        filtered_vms: >-
          {{
          (provider_vms.json | default([]) | list)
          | selectattr('path', 'search', (filter_vm_folder_path | default()))
          | list
          }}
          
      vars:
        identity: "{{ item for item in (provider_vms.json | default([]) | list) | list }}"

    - name: Debug filtered VMs selected for migration
      debug:
        msg:
          folder_filter: "{{ filter_vm_folder_path }}"
          name_regex_filter: "{{ filter_vm_name_regex | default('none') }}"
          vm_count: "{{ (filtered_vms | default([])) | length }}"
          vm_names: "{{ (filtered_vms | default([]) | map(attribute='name') | list) }}"

    - name: Set vm_ids from filtered VMs (unless vm_names override provided)
      set_fact:
        vm_ids: >-
          {{
            ((vm_names | default([]) | length) > 0)
            | ternary(
                (provider_vms.json
                  | selectattr('name','in', vm_names | default([]))
                  | map(attribute='id') | list),
                (filtered_vms | map(attribute='id') | list)
              )
          }}

    - name: Fail if no VM ids found
      fail:
        msg: "No VM ids found to migrate. Check folder path filter and vm_names."
      when: vm_ids | length == 0

    - name: Build NDA items with computed nad_name per mapping
      set_fact:
        nad_items:
          "{{ nad_items | default([]) + [ item_with_nad ] }}"
      vars:
        item_with_nad:
        source: "{{ item.source | default({}) }}"
        destination: "{{ item.destination | default({}) }}"
        nad_name: >-
          {{
          item.destination.nad_name
          | default( (nad_name_single | default('')) | default(nad_name_prefix | default('') ~ item.destination.name) )
          }}
      loop: "{{ network_mappings | default([]) }}"
      loop_control:
        label: "{{ item.destination.name | default('unnamed') }}"
      when: network_mappings | length > 0

    - name: Debug computed nad_items
      debug:
        var: nad_items
      when: network_mappings | length > 0


    # Ensure the target namespace exists before creating NADs
    - name: Ensure target namespace exists
      redhat.openshift.k8s:
        state: present
        validate_certs: false
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ target_ns }}"

    - name: Debug NAD-related vars
      debug: 
        msg: 
          network_mappings: "{{ network_mappings }}" 
          nad_name: "{{ nad_name | default('undefined') }}"
          nad_items: "{{ nad_items | default('undefined') }}"

    # Create NetworkAttachmentDefinitions for networks referred in network_mappings, in target_ns
    - name: Create NetworkAttachmentDefinitions in target namespace
      redhat.openshift.k8s:
        state: present
        namespace: "{{ target_ns }}"
        definition:
          apiVersion: k8s.cni.cncf.io/v1
          kind: NetworkAttachmentDefinition
          metadata:
            name: "{{ nad_name }}" 
            namespace: "{{ target_ns }}"
          spec: 
            config: "{{ {'cniVersion': '0.3.1', 'type': 'cnv-bridge', 'bridge': 'br1', 'name': item.nad_name, 'macspoofchk': 'true'} | to_nice_json }}"


    - name: Create or update NetworkMap resource in MTV namespace
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: NetworkMap
          metadata:
            name: "{{ network_map_name }}"
            namespace: "{{ ns }}"
          spec:
            map:
              - destination:
                  name: "{{ nad_name }}"
                  namespace: "{{ target_ns }}"
                  type: multus
                source:
                  id: "{{ vmware_network_id }}" 
                  name: "{{ vmware_network_name }}"              
            provider:
              source:
                name: "{{ provider_name }}"
                namespace: "{{ ns }}"
              destination:
                name: host
                namespace: "{{ ns }}"

    - name: Create or update StorageMap resource in MTV namespace
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: StorageMap
          metadata:
            name: "{{ storage_map_name }}"
            namespace: "{{ ns }}"
          spec:
            map:
              - destination:
                  storageClass: "{{ storage_destination_storageclass }}"
                source:
                  name: "{{ storage_map_source_name }}"
            provider:
              source:
                name: "{{ provider_name }}"
                namespace: "{{ ns }}"
              destination:
                name: host
                namespace: "{{ ns }}"

    - name: Build vms_plan_spec from vm_ids
      set_fact:
        vms_plan_spec: "{{ vms_plan_spec | default([]) + [{'hooks': [], 'id': item}] }}"
      loop: "{{ vm_ids }}"

    - name: Create migration Plan resource
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Plan
          metadata:
            name: "{{ plan_name }}"
            namespace: "{{ ns }}"
          spec:
            warm: false
            provider:
              source:
                name: "{{ provider_name }}"
                namespace: "{{ ns }}"
              destination:
                name: host
                namespace: "{{ ns }}"
            map:
              network:
                name: "{{ network_map_name }}"
                namespace: "{{ ns }}"
              storage:
                name: "{{ storage_map_name }}"
                namespace: "{{ ns }}"
            targetNamespace: "{{ target_ns }}"
            vms: "{{ vms_plan_spec | default([]) }}"

    - name: Optionally start the Migration (create Migration CR) - set start_migration=true to execute
      when: start_migration | default(false)
      redhat.openshift.k8s:
        state: present
        namespace: "{{ ns }}"
        validate_certs: false
        wait: true
        wait_condition:
          type: Succeeded
          status: "True"
        wait_timeout: "{{ migration_wait_timeout | default(1800) }}"
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Migration
          metadata:
            name: "{{ plan_name }}-migration"
            namespace: "{{ ns }}"
          spec:
            plan:
              name: "{{ plan_name }}"
              namespace: "{{ ns }}"
